# MediaPipe Walk Analysis

## README.md

---

## Overview

This workflow automates the analysis of patient walk videos through the following steps:

1. [**Trigger: Webhook**](#1-trigger-webhook)\
   Receives incoming webhook requests containing patient and video data.

2. [**JSON Parsing**](#2-json-parsing)\
   Parses incoming payload for structured downstream mapping.

3. [**Router: Branch Logic**](#3-router-branch-logic)\
   Directs workflow based on available data (e.g., checks if video path exists).

4. [**Video Processing Steps**](#4-video-processing-steps)\
   Handles video file retrieval from Google Drive and uploads to Google Cloud Storage.

5. [**Feature Extraction and Cloud Analysis**](#5-feature-extraction-and-cloud-analysis)\
   Processes videos through sequential Cloud Run functions to extract walk features using MediaPipe. After each function, a Large Language Model (LLM) generates a classification label, score, and summary for each metric, producing structured (JSON) outputs for reporting and automation.

6. [**Analysis & Reporting Branches**](#6-analysis--reporting-branches)\
   Computes arm swing, tilt, and head displacement metrics; each branch uses AI/GPT modules for automated scoring, risk assessment, and narrative summary generation; generates graphs and scores using AI.

7. [**Result Aggregation**](#7-result-aggregation)\
   Aggregates all analysis results and outputs for record creation.

8. [**Airtable Logging**](#8-airtable-logging)\
   Logs all results into Airtable for audit and reporting.

9. [**Presentation & Document Generation and Delivery**](#9-presentation--document-generation-and-delivery)\
   Automatically generates a Google Slides presentation and Google Doc from templates, and emails them to the end user via Microsoft OAUTH.

---

## Diagram

```
[1. Webhook]
   │
   ├──▶ [2. Google Drive: Get Video]
   │       │
   │       ▼
   │  [3. GCS: Upload Video]
   │       │
   │       ▼
   └──▶ [4. Cloud Functions: Extract Data]
             │
             ▼
      [5. Cloud Functions: Feature Extraction & LLM Scoring]
             │
             ▼
      [6. Graph API: Generate Plots]
             │
             ▼
      [7. Airtable: Log Results]
             │
             ▼
[8. Google Slides: Create Presentation]
             │
             ▼
 [8. Google Docs: Create Document]
             │
             ▼
 [9. Microsoft OAUTH: Send Email to User]
```

---



## Detailed Workflow

### 1. **Trigger: Webhook**

- **Route:** `/webhook`
- **Module:** `gateway:CustomWebHook`
- Receives a POST request with form data and (optionally) video metadata.

### 2. **JSON Parsing**

- **Route:** internal mapping (not exposed).
- **Module:** `json:ParseJSON`
- Parses the incoming payload for easier downstream mapping.

### 3. **Router: Branch Logic**

- **Route:** Internal.
- **Module:** `builtin:BasicRouter`
- Directs the flow based on available data (e.g., checks if video path exists).

---

### 4. **Video Processing Steps**

- **A. Video Exists Branch**
  - **Extract Video ID:** Extracts video filename from the payload.
  - **Google Drive Search:** Searches for video in the specified folder.
  - **Download Video:** Downloads from Drive.
  - **Upload to GCS:** Uploads to Google Cloud Storage bucket.

---

### 5. **Feature Extraction and Cloud Analysis**

Feature data from walk videos is generated by a **series of serverless functions** (deployed on Google Cloud Run), each responsible for a specific phase of MediaPipe walk analysis. These functions are triggered **sequentially** in Make.com, processing the video through multiple specialized endpoints. Each function may extract, process, or compute different pose and motion metrics using MediaPipe and related data science libraries.

#### **Requirements**

- **Python 3.8+**
- **MediaPipe** (`mediapipe`): for pose estimation
- **OpenCV** (`opencv-python`): for video frame processing
- **NumPy & Pandas**: for numeric and DataFrame operations
- **Google Cloud Storage Python client** (`google-cloud-storage`): for cloud file operations
- *(Optional)* **PyDrive2**: for Google Drive workflows

#### **Processing Flow**

```
1. Authenticate & Access Video
   - Securely connect to Google Cloud Storage or Google Drive
   - Download the specified video file using a unique file ID

2. Sequential Cloud Functions (Orchestrated by Make.com)
   - Functions are called one after another, each handling a distinct part of the analysis:
        • DataFrame Extraction (e.g., "da-df")
        • MediaPipe Video Keypoint Extraction (e.g., "mediapipe-video")
        • Arm Swing Feature Calculation (e.g., "arm-swing-function")
        • Symmetry and Angle Analysis (e.g., "symmetry-function")
        • General Statistical Feature Calculation (e.g., "calculate-all-stats-function")

3. Frame-by-Frame Processing
   - Each function may read/process the video frame by frame
   - MediaPipe Pose is used to detect and extract body landmarks (x, y, z, visibility)

4. LLM (GPT) Module Integration
   - After each Cloud Function produces its output, the relevant data is sent to a Large Language Model (LLM, e.g., OpenAI GPT-3.5/4) via Make.com.
   - The LLM, prompted as an orthopedist, generates:
       • A general classification label for the metric or route (e.g., Good, OK, Needs Improvement)
       • A numeric score for quality or risk (typically 1–10)
       • A short summary explaining the reasoning, tailored for each analysis route
   - All outputs are formatted as RFC8259-compliant JSON for automation.


5. Data Aggregation & Formatting
   - Outputs from each function (including the AI-generated scoring/summary) are collected as DataFrames or JSON dictionaries for downstream analysis and graphing

6. Modular/Stateless Execution
   - Each function is stateless and triggered via HTTP POST (requiring a `file_id` or similar identifier)
   - Credentials and configuration are securely managed at deployment

7. Output
   - The Make.com scenario aggregates outputs from all functions and LLM modules for further analysis, visualization, and reporting
```

> **Note:**
>
> - The pipeline is modular, enabling updates or additions to individual functions or AI modules without breaking the overall flow.
> - You may see functions such as `da-df`, `mediapipe-video`, `arm-swing-function`, `symmetry-function`, and `calculate-all-stats-function`, each followed by LLM analysis in the blueprint.

---



### 6. **Analysis & Reporting Branches**

**Each metric is processed via a router. Main analysis includes:**

#### A. **Arm Swing**

- **Endpoint:** *(POST URL hidden for public viewing)*
  - Takes DataFrame as input.
  - Uses GPT for scoring:
    - Classes: `Good`, `OK`, `Needs Improvement`
    - Rating: 1-10
    - 50-word summary.
- **Graph Generation:** *(POST URL hidden for public viewing)*
  - Returns plot image for the arm swing.

#### B. **Tilt Analysis**

- **Endpoint:** *(POST URL hidden for public viewing)*
  - GPT analysis on hip/shoulder tilt.
- **Graph Generation:** *(POST URL hidden for public viewing)*
  - Returns plot image for tilt.

#### C. **Head Displacement**

- **Endpoint:** *(POST URL hidden for public viewing)*
  - GPT analysis on head movement stability.
- **Graph Generation:** *(POST URL hidden for public viewing)*
  - Returns plot image for head movement.

---

### 7. **Result Aggregation**

- All analysis results, scores, explanations, and plot references are stored as variables for final record creation.

---

### 8. **Airtable Logging**

- **Table:** `"Walk Analysis"`
- **Purpose:** Stores results from the workflow for review and reporting.
- **Action:** New record is created for each processed video/analysis run.

---

### 9. **Presentation & Document Generation and Delivery**

After logging results to Airtable, the workflow automatically generates:

- **Google Slides Presentation**\
  A Google Slides deck is created from a pre-defined template, populated with key findings, scores, and charts from the analysis.

- **Google Document Report**\
  A Google Doc is generated from a template, summarizing results and including narrative explanations and visual outputs.

- **Automated Email Delivery (Microsoft OAUTH)**\
  Both the presentation and document are attached to an email, which is sent securely to the end user via Microsoft Outlook (OAUTH connection).

---

## **API/Automation Routes Summary**

| Route/Action                   | Description                        | Method | Input/Params                   |
| ------------------------------ | ---------------------------------- | ------ | ------------------------------ |
| `/webhook`                     | Entry webhook for form submissions | POST   | Form/video data                |
| `da-df`                        | DataFrame extraction from video    | POST   | file\_id                       |
| `mediapipe-video`              | ML keypoint extraction on video    | POST   | file\_id                       |
| `arm-swing-function`           | Arm swing metric analysis (GPT-4o) | POST   | DataFrame (JSON)               |
| `calculate-all-stats-function` | Tilt or Head Displacement analysis | POST   | DataFrame (JSON), action param |
| `graph-api`                    | Generates visual plots per metric  | POST   | action, file\_id, data         |
| Airtable API                   | Record creation in "Walk Analysis" | POST   | Structured analysis results    |

---

## **Cloud Functions Used**

- **Google Cloud Functions** for:

  - Data processing
  - Metric-specific analysis
  - Graph/image generation

- **OpenAI GPT-4o** for medical-grade scoring and narrative summary.

---

## **Key Variables and Outputs**

- **Scores and Summaries:** For each metric (Arm Swing, Tilt, Head Movement).
- **Plot Images:** URL or filename for each generated plot.
- **Final Record:** All values and links written to Airtable for audit, reporting, or follow-up.

---

## **Error Handling**

- Each major block (file access, cloud upload, HTTP call, etc.) features `onerror` commits to log failures or halt execution for easier troubleshooting.

---

## **How To Use**

1. **Deploy all referenced Google Cloud Functions and ensure access/configs.**
2. **Configure webhook with client or form provider.**
3. **Grant API access to Google Drive, GCS, and Airtable.**
4. **Send a POST request (or form) with required video metadata to ****\`\`****.**
5. **Review outputs in Airtable and retrieve images/plots as referenced.**

---

## **References**

- See the workflow blueprint for exact variable names, field mappings, and module configurations.
- For troubleshooting, refer to the onerror paths and logs generated by the automation platform.

